# DOS Chain Mainnet - Block Explorer (Blockscout)
# doscan.io
# Deployed on archive VM (20.195.24.239)
# AvalancheGo runs as native systemd service (NOT in this compose)

services:
  # ==========================================================================
  # Database
  # ==========================================================================
  redis-db:
    image: redis:alpine
    container_name: redis-db
    restart: always
    command: redis-server
    volumes:
      - redis_data:/data

  db-init:
    image: postgres:15
    volumes:
      - postgres_data:/var/lib/postgresql/data
    entrypoint:
      - sh
      - -c
      - |
        chown -R 2000:2000 /var/lib/postgresql/data

  db:
    depends_on:
      db-init:
        condition: service_completed_successfully
    image: postgres:15
    shm_size: 256m
    restart: always
    container_name: db
    user: 2000:2000
    command: postgres -c 'max_connections=200' -c 'client_connection_check_interval=60000'
    environment:
      POSTGRES_PASSWORD: ""
      POSTGRES_USER: "postgres"
      POSTGRES_HOST_AUTH_METHOD: "trust"
    ports:
      - "127.0.0.1:7432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # ==========================================================================
  # Backend - Blockscout Latest
  # ==========================================================================
  backend:
    depends_on:
      - db
      - redis-db
    image: doscan-backend:latest
    pull_policy: never
    restart: always
    stop_grace_period: 5m
    container_name: backend
    command: sh -c 'bin/blockscout eval "Elixir.Explorer.ReleaseTasks.create_and_migrate()" && bin/blockscout start'
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    env_file:
      - ./envs/common-blockscout.env
    links:
      - db:database
    ports:
      - "127.0.0.1:4000:4000"

  # ==========================================================================
  # Frontend - Blockscout Latest
  # ==========================================================================
  frontend:
    depends_on:
      - backend
    image: doscan-frontend:latest
    pull_policy: never
    restart: always
    container_name: frontend
    env_file:
      - ./envs/common-frontend.env
    ports:
      - "127.0.0.1:3000:3000"

  # ==========================================================================
  # Microservices
  # ==========================================================================
  smart-contract-verifier:
    image: ghcr.io/blockscout/smart-contract-verifier:latest
    pull_policy: always
    platform: linux/amd64
    restart: always
    container_name: smart-contract-verifier
    env_file:
      - ./envs/common-smart-contract-verifier.env
    ports:
      - "127.0.0.1:8043:8050"

  visualizer:
    image: ghcr.io/blockscout/visualizer:latest
    pull_policy: always
    platform: linux/amd64
    restart: always
    container_name: visualizer
    env_file:
      - ./envs/common-visualizer.env
    ports:
      - "127.0.0.1:8044:8050"

  sig-provider:
    image: ghcr.io/blockscout/sig-provider:latest
    pull_policy: always
    platform: linux/amd64
    restart: always
    container_name: sig-provider
    ports:
      - "127.0.0.1:8045:8050"

  # ==========================================================================
  # Stats Service
  # ==========================================================================
  stats:
    depends_on:
      - db
    image: ghcr.io/blockscout/stats:latest
    pull_policy: always
    platform: linux/amd64
    restart: always
    container_name: stats
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      STATS__DB_URL: "postgresql://postgres:@db:5432/stats"
      STATS__BLOCKSCOUT_DB_URL: "postgresql://postgres:@db:5432/blockscout"
      STATS__CREATE_DATABASE: "true"
      STATS__RUN_MIGRATIONS: "true"
      STATS__SERVER__HTTP__ADDR: "0.0.0.0:8050"
      STATS__SERVER__HTTP__CORS__ALLOWED_ORIGIN: "https://doscan.io"
      STATS__IGNORE_BLOCKSCOUT_API_ABSENCE: "true"
    ports:
      - "127.0.0.1:8052:8050"

  # ==========================================================================
  # Caddy - Reverse Proxy with Cloudflare Origin SSL
  # ==========================================================================
  caddy:
    depends_on:
      - backend
      - frontend
    image: caddy:latest
    container_name: caddy
    restart: always
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - ./certs:/etc/caddy/certs:ro
      - caddy_data:/data
      - caddy_config:/config
    ports:
      - "80:80"
      - "443:443"

volumes:
  postgres_data:
  redis_data:
  caddy_data:
  caddy_config:
